name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-24.04
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache CI image
        id: cache-image
        uses: actions/cache@v4
        with:
          path: /tmp/ci-image.tar
          key: ${{ runner.os }}-ci-image-${{ hashFiles('Dockerfile') }}

      - name: Build CI image (if cache miss)
        if: steps.cache-image.outputs.cache-hit != 'true'
        run: |
          docker build -f Dockerfile -t loopautoma/ci:cached .
          docker save loopautoma/ci:cached -o /tmp/ci-image.tar

      - name: Load CI image (from cache)
        if: steps.cache-image.outputs.cache-hit == 'true'
        run: |
          docker load -i /tmp/ci-image.tar

      - name: Prepare Workspace (install deps inside container)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace loopautoma/ci:cached \
            bash -lc 'if [[ -f package.json ]]; then bun install; else echo "No package.json"; fi'

      - name: UI tests (only if tests exist)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace loopautoma/ci:cached bash -lc '
            if [[ ! -f package.json ]]; then echo "No package.json; skipping UI tests"; exit 0; fi
            count=$(find . \( -path './node_modules' -o -path './dist' -o -path './.turbo' -o -path './.next' \) -prune -false -o \
                     -type f \( -name "*.test.*" -o -name "*.spec.*" -o -path "./tests/*" \) | wc -l)
            if [[ "$count" -gt 0 ]]; then
              echo "Found $count test files. Running bun test with coverage..."
              bun test --coverage
              if [[ -d coverage ]]; then echo "UI coverage dir exists"; else echo "No UI coverage dir; will rely on runner output"; fi
              echo "Also running vitest to produce lcov..."
              bun run test:ui:cov || true
            else
              echo "No UI tests found. Skipping bun test."
            fi'

      - name: Rust tests (if src-tauri exists)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace loopautoma/ci:cached bash -lc '
            if [[ -d src-tauri ]]; then (cd src-tauri && cargo test --all --locked); else echo "No src-tauri/; skipping Rust tests"; fi'

      - name: Rust coverage (tarpaulin)
        if: ${{ hashFiles('src-tauri/Cargo.toml') != '' }}
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace loopautoma/ci:cached bash -lc '
            cd src-tauri && cargo tarpaulin --out Xml --timeout 120 --engine llvm || cargo tarpaulin --out Xml --timeout 120
            cd ..
            echo "Generated Rust coverage: src-tauri/tarpaulin-report.xml"'

      - name: Upload coverage to Codecov
        if: ${{ always() }}
        uses: codecov/codecov-action@v4
        with:
          files: |
            src-tauri/tarpaulin-report.xml
          flags: rust
          fail_ci_if_error: false

      - name: Upload UI coverage to Codecov (if found)
        if: ${{ always() && hashFiles('coverage/lcov.info') != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          flags: ui
          fail_ci_if_error: false

      - name: Tauri build (smoke, if app present)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace loopautoma/ci:cached bash -lc '
            if [[ -f package.json && -f src-tauri/Cargo.toml ]]; then
              bun run tauri build || echo "Skipping failure of bundling in CI smoke"
            else
              echo "No Tauri app detected; skipping bundling"
            fi'
