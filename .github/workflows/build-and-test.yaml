name: Build and test

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      image:
        required: false
        type: string

jobs:
  run:
    name: Build and test (Rust + TS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Determine CI image
        id: image
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            echo "ref=${{ inputs.image }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=ghcr.io/${{ github.repository_owner }}/loopautoma-ci:latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GitHub Container Registry
        if: ${{ startsWith(steps.image.outputs.ref, 'ghcr.io/') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${{ steps.image.outputs.ref }}" || echo "Image not found, will attempt local build in job-specific steps if needed"

      - name: Bun install
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace "${{ steps.image.outputs.ref }}" \
            bash -lc 'if [[ -f package.json ]]; then bun install; else echo "No package.json"; fi'

      - name: UI tests (Vitest w/ coverage)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace "${{ steps.image.outputs.ref }}" bash -lc '
            if [[ ! -f package.json ]]; then echo "No package.json; skipping UI tests"; exit 0; fi
            bun run test:ui:cov || true'

      - name: Rust tests
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace "${{ steps.image.outputs.ref }}" bash -lc '
            if [[ -d src-tauri ]]; then (cd src-tauri && cargo test --all --locked); else echo "No src-tauri/; skipping Rust tests"; fi'

      - name: Rust coverage (tarpaulin)
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace "${{ steps.image.outputs.ref }}" bash -lc '
            if [[ -f src-tauri/Cargo.toml ]]; then cd src-tauri && cargo tarpaulin --out Xml --timeout 120 --engine llvm || cargo tarpaulin --out Xml --timeout 120; fi'

      - name: Upload coverage to Codecov (Rust)
        if: ${{ always() }}
        uses: codecov/codecov-action@v4
        with:
          files: src-tauri/tarpaulin-report.xml
          flags: rust
          fail_ci_if_error: false

      - name: Upload UI coverage to Codecov (best-effort)
        if: ${{ always() }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          flags: ui
          fail_ci_if_error: false
