name: Build and test

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      image:
        required: false
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Build and test (Rust + TS)
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image != '' && inputs.image || format('ghcr.io/{0}/loopautoma-ci:latest', github.repository_owner) }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      CARGO_TARGET_DIR: /workspace/target
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Environment diagnostics (Rust)
        run: |
          set -x
          echo "CARGO_TARGET_DIR=${CARGO_TARGET_DIR}"
          echo "CARGO_HOME=${CARGO_HOME}"
          echo "RUSTUP_HOME=${RUSTUP_HOME}"
          echo "PWD=$(pwd)"
          which cargo || true
          cargo -vV || true
          rustc -vV || true
          echo "Listing /workspace/target (if present):"
          ls -la /workspace/target || true
          echo "Listing src-tauri/target (if present):"
          ls -la src-tauri/target || true

      - name: Bun version
        run: bun --version || true

      - name: Install system dependencies (X11 input)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends libxkbcommon-x11-dev libxcb-xkb-dev

      - name: Install dependencies (UI)
        run: |
          if [ -f package.json ]; then bun install --frozen-lockfile || bun install; else echo "No package.json"; fi

      - name: UI tests (Vitest with coverage)
        run: |
          if [ -f package.json ]; then bun run test:ui:cov || true; else echo "No UI; skipping"; fi

      - name: Rust tests
        run: |
          if [ -d src-tauri ]; then (cd src-tauri && cargo test --all --locked); else echo "No src-tauri/; skipping"; fi

      - name: Rust coverage (llvm-cov)
        run: |
          if [ -f src-tauri/Cargo.toml ]; then (
            cd src-tauri && \
            cargo llvm-cov --workspace --locked --lcov --output-path lcov.info
          ); fi

      - name: Collect coverage artifacts
        id: coverage
        if: ${{ always() }}
        run: |
          set -euo pipefail
          mkdir -p coverage-artifacts
          if [ -f src-tauri/lcov.info ]; then
            cp src-tauri/lcov.info coverage-artifacts/rust.lcov
          fi
          if [ -f coverage/lcov.info ]; then
            cp coverage/lcov.info coverage-artifacts/ui.lcov
          fi
          shopt -s nullglob
          declare -a files=()
          for f in coverage-artifacts/*.lcov; do
            files+=("$f")
          done
          if [ "${#files[@]}" -gt 0 ]; then
            (IFS=','; echo "files=${files[*]}" >> "$GITHUB_OUTPUT")
          else
            echo "files=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload coverage to Codecov
        if: ${{ always() && steps.coverage.outputs.files != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: ${{ steps.coverage.outputs.files }}
          fail_ci_if_error: false
